<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbitrage Scanner - Kalshi vs Polymarket</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .gradient-bg { background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 50%, #0f1a2e 100%); }
        .card-glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .glow-green { box-shadow: 0 0 30px rgba(34, 197, 94, 0.3); }
        .glow-red { box-shadow: 0 0 30px rgba(239, 68, 68, 0.3); }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .scanning { animation: scanning 1.5s ease-in-out infinite; }
        @keyframes scanning {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        const API_URL = 'https://web-production-eca1e.up.railway.app';

        // Formatar moeda
        const formatUSD = (value) => {
            if (value === null || value === undefined) return '-';
            return `$${value.toFixed(4)}`;
        };

        // Formatar porcentagem
        const formatPercent = (value) => {
            if (value === null || value === undefined) return '-';
            return `${value.toFixed(2)}%`;
        };

        // Componente de Status
        const StatusBadge = ({ scanning, lastScan }) => (
            <div className="flex items-center gap-4">
                {scanning ? (
                    <div className="flex items-center gap-2 bg-yellow-500/20 px-4 py-2 rounded-full border border-yellow-500/30">
                        <div className="w-2 h-2 bg-yellow-400 rounded-full pulse"></div>
                        <span className="text-yellow-400 text-sm font-medium">Escaneando...</span>
                    </div>
                ) : (
                    <div className="flex items-center gap-2 bg-green-500/20 px-4 py-2 rounded-full border border-green-500/30">
                        <div className="w-2 h-2 bg-green-400 rounded-full"></div>
                        <span className="text-green-400 text-sm font-medium">Pronto</span>
                    </div>
                )}
                {lastScan && (
                    <span className="text-gray-400 text-sm">
                        √öltimo scan: {new Date(lastScan).toLocaleTimeString('pt-BR')}
                    </span>
                )}
            </div>
        );

        // Componente de Oportunidade
        const OpportunityCard = ({ opportunity, rank }) => {
            const isHighEdge = opportunity.edge_percentage >= 5;
            
            return (
                <div className={`card-glass rounded-xl p-5 transition-all duration-300 ${isHighEdge ? 'glow-green' : ''}`}>
                    <div className="flex items-start justify-between mb-4">
                        <div className="flex items-center gap-3">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold ${
                                rank === 1 ? 'bg-yellow-500 text-black' :
                                rank === 2 ? 'bg-gray-400 text-black' :
                                rank === 3 ? 'bg-amber-600 text-black' :
                                'bg-gray-700 text-white'
                            }`}>
                                {rank}
                            </div>
                            <div>
                                <div className={`text-2xl font-bold mono ${isHighEdge ? 'text-green-400' : 'text-white'}`}>
                                    {formatPercent(opportunity.edge_percentage)}
                                </div>
                                <div className="text-xs text-gray-400">Edge</div>
                            </div>
                        </div>
                        <div className="text-right">
                            <div className="text-xl font-bold text-green-400 mono">
                                {formatUSD(opportunity.net_profit)}
                            </div>
                            <div className="text-xs text-gray-400">Lucro L√≠quido</div>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div className="bg-blue-500/10 border border-blue-500/20 rounded-lg p-3">
                            <div className="text-blue-400 text-xs font-medium mb-1 flex items-center gap-1">
                                <span className="w-2 h-2 bg-blue-400 rounded-full"></span>
                                KALSHI
                            </div>
                            <div className="text-sm font-medium truncate" title={opportunity.kalshi_title}>
                                {opportunity.kalshi_title}
                            </div>
                            <div className="text-xs text-gray-400 mono mt-1">{opportunity.kalshi_ticker}</div>
                            <div className="text-xs text-gray-500 mt-1">VWAP: {formatUSD(opportunity.kalshi_vwap)}</div>
                        </div>
                        
                        <div className="bg-purple-500/10 border border-purple-500/20 rounded-lg p-3">
                            <div className="text-purple-400 text-xs font-medium mb-1 flex items-center gap-1">
                                <span className="w-2 h-2 bg-purple-400 rounded-full"></span>
                                POLYMARKET
                            </div>
                            <div className="text-sm font-medium truncate" title={opportunity.polymarket_title}>
                                {opportunity.polymarket_title}
                            </div>
                            <div className="text-xs text-gray-400 mono mt-1">{opportunity.polymarket_ticker}</div>
                            <div className="text-xs text-gray-500 mt-1">VWAP: {formatUSD(opportunity.polymarket_vwap)}</div>
                        </div>
                    </div>

                    <div className="grid grid-cols-4 gap-2 text-center text-xs">
                        <div className="bg-black/20 rounded p-2">
                            <div className="text-gray-400">Similaridade</div>
                            <div className="mono font-medium">{formatPercent(opportunity.similarity_score * 100)}</div>
                        </div>
                        <div className="bg-black/20 rounded p-2">
                            <div className="text-gray-400">Contratos</div>
                            <div className="mono font-medium">{opportunity.contracts.toFixed(2)}</div>
                        </div>
                        <div className="bg-black/20 rounded p-2">
                            <div className="text-gray-400">Custo</div>
                            <div className="mono font-medium">{formatUSD(opportunity.total_cost)}</div>
                        </div>
                        <div className="bg-black/20 rounded p-2">
                            <div className="text-gray-400">Fees</div>
                            <div className="mono font-medium text-yellow-400">{formatUSD(opportunity.total_fees)}</div>
                        </div>
                    </div>

                    <div className="mt-3 flex items-center justify-between text-xs">
                        <span className="text-gray-500">Estrat√©gia: {opportunity.strategy}</span>
                        <span className="text-gray-500">{opportunity.match_reason}</span>
                    </div>
                </div>
            );
        };

        // Componente de Estat√≠sticas
        const StatsPanel = ({ scanResult }) => {
            if (!scanResult) return null;
            
            return (
                <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                    <div className="card-glass rounded-lg p-4 text-center">
                        <div className="text-3xl font-bold text-blue-400">{scanResult.kalshi_markets_scanned}</div>
                        <div className="text-xs text-gray-400 mt-1">Mercados Kalshi</div>
                    </div>
                    <div className="card-glass rounded-lg p-4 text-center">
                        <div className="text-3xl font-bold text-purple-400">{scanResult.polymarket_markets_scanned}</div>
                        <div className="text-xs text-gray-400 mt-1">Mercados Poly</div>
                    </div>
                    <div className="card-glass rounded-lg p-4 text-center">
                        <div className="text-3xl font-bold text-white">{scanResult.pairs_analyzed}</div>
                        <div className="text-xs text-gray-400 mt-1">Pares Analisados</div>
                    </div>
                    <div className="card-glass rounded-lg p-4 text-center">
                        <div className={`text-3xl font-bold ${scanResult.opportunities_found > 0 ? 'text-green-400' : 'text-gray-500'}`}>
                            {scanResult.opportunities_found}
                        </div>
                        <div className="text-xs text-gray-400 mt-1">Oportunidades</div>
                    </div>
                    <div className="card-glass rounded-lg p-4 text-center">
                        <div className="text-3xl font-bold text-yellow-400">{scanResult.scan_duration_seconds.toFixed(1)}s</div>
                        <div className="text-xs text-gray-400 mt-1">Dura√ß√£o</div>
                    </div>
                </div>
            );
        };

        // Componente de Rejei√ß√µes
        const RejectionsPanel = ({ rejections }) => {
            if (!rejections || Object.keys(rejections).length === 0) return null;
            
            const total = Object.values(rejections).reduce((a, b) => a + b, 0);
            
            return (
                <div className="card-glass rounded-lg p-4 mb-6">
                    <div className="text-sm font-medium mb-3 flex items-center gap-2">
                        <span className="text-gray-400">Rejei√ß√µes ({total} total)</span>
                        <span className="text-xs text-gray-500">‚Äî Comportamento esperado</span>
                    </div>
                    <div className="flex flex-wrap gap-2">
                        {Object.entries(rejections).map(([code, count]) => (
                            <span key={code} className="bg-red-500/10 border border-red-500/20 text-red-400 px-3 py-1 rounded-full text-xs">
                                {code}: {count}
                            </span>
                        ))}
                    </div>
                </div>
            );
        };

        // Componente de Configura√ß√£o
        const ConfigPanel = ({ config, setConfig, onScan, scanning }) => (
            <div className="card-glass rounded-lg p-4 mb-6">
                <div className="flex flex-wrap items-center gap-4">
                    <div>
                        <label className="text-xs text-gray-400 block mb-1">Valor Alvo (USD)</label>
                        <input 
                            type="number" 
                            value={config.target_usd}
                            onChange={(e) => setConfig({...config, target_usd: Number(e.target.value)})}
                            className="w-24 bg-black/30 border border-gray-600 rounded px-3 py-2 text-white mono"
                        />
                    </div>
                    <div>
                        <label className="text-xs text-gray-400 block mb-1">Similaridade M√≠n.</label>
                        <input 
                            type="number" 
                            step="0.1"
                            min="0"
                            max="1"
                            value={config.min_similarity}
                            onChange={(e) => setConfig({...config, min_similarity: Number(e.target.value)})}
                            className="w-20 bg-black/30 border border-gray-600 rounded px-3 py-2 text-white mono"
                        />
                    </div>
                    <div>
                        <label className="text-xs text-gray-400 block mb-1">Max Mercados</label>
                        <input 
                            type="number" 
                            value={config.max_markets}
                            onChange={(e) => setConfig({...config, max_markets: Number(e.target.value)})}
                            className="w-20 bg-black/30 border border-gray-600 rounded px-3 py-2 text-white mono"
                        />
                    </div>
                    <div className="flex-1"></div>
                    <button
                        onClick={onScan}
                        disabled={scanning}
                        className={`px-8 py-3 rounded-lg font-bold text-lg transition-all flex items-center gap-2 ${
                            scanning 
                                ? 'bg-gray-600 text-gray-400 cursor-not-allowed' 
                                : 'bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-black'
                        }`}
                    >
                        {scanning ? (
                            <>
                                <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                                </svg>
                                Escaneando...
                            </>
                        ) : (
                            <>
                                üîç Escanear Agora
                            </>
                        )}
                    </button>
                </div>
            </div>
        );

        // Componente Principal
        const App = () => {
            const [scanning, setScanning] = useState(false);
            const [scanResult, setScanResult] = useState(null);
            const [error, setError] = useState(null);
            const [autoScan, setAutoScan] = useState(false);
            const [config, setConfig] = useState({
                target_usd: 20,
                min_similarity: 0.3,
                max_markets: 30
            });

            const runScan = useCallback(async () => {
                if (scanning) return;
                
                setScanning(true);
                setError(null);
                
                try {
                    const response = await fetch(`${API_URL}/scan`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    setScanResult(data);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setScanning(false);
                }
            }, [config, scanning]);

            // Auto-scan a cada 2 minutos
            useEffect(() => {
                if (!autoScan) return;
                
                const interval = setInterval(runScan, 120000);
                return () => clearInterval(interval);
            }, [autoScan, runScan]);

            // Carregar √∫ltimo scan ao iniciar
            useEffect(() => {
                fetch(`${API_URL}/scan/last`)
                    .then(res => res.json())
                    .then(data => {
                        if (data) setScanResult(data);
                    })
                    .catch(() => {});
            }, []);

            return (
                <div className="min-h-screen p-6">
                    {/* Header */}
                    <header className="mb-8">
                        <div className="flex items-center justify-between flex-wrap gap-4">
                            <div>
                                <h1 className="text-3xl font-bold flex items-center gap-3">
                                    <span className="text-4xl">üéØ</span>
                                    Arbitrage Scanner
                                </h1>
                                <p className="text-gray-400 mt-1">
                                    Detec√ß√£o autom√°tica de arbitragem Kalshi vs Polymarket
                                </p>
                            </div>
                            
                            <div className="flex items-center gap-4">
                                <StatusBadge 
                                    scanning={scanning} 
                                    lastScan={scanResult?.timestamp}
                                />
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input 
                                        type="checkbox"
                                        checked={autoScan}
                                        onChange={(e) => setAutoScan(e.target.checked)}
                                        className="w-4 h-4 rounded"
                                    />
                                    <span className="text-sm text-gray-400">Auto-scan (2min)</span>
                                </label>
                            </div>
                        </div>
                    </header>

                    {/* Barra de Progresso durante scan */}
                    {scanning && (
                        <div className="h-1 bg-gray-800 rounded-full mb-6 overflow-hidden">
                            <div className="h-full w-1/3 bg-gradient-to-r from-green-500 to-emerald-400 rounded-full scanning"></div>
                        </div>
                    )}

                    {/* Configura√ß√£o e Bot√£o */}
                    <ConfigPanel 
                        config={config}
                        setConfig={setConfig}
                        onScan={runScan}
                        scanning={scanning}
                    />

                    {/* Erro */}
                    {error && (
                        <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-6">
                            <div className="text-red-400">Erro: {error}</div>
                        </div>
                    )}

                    {/* Estat√≠sticas */}
                    <StatsPanel scanResult={scanResult} />

                    {/* Rejei√ß√µes */}
                    <RejectionsPanel rejections={scanResult?.rejections_summary} />

                    {/* Oportunidades */}
                    {scanResult && (
                        <div>
                            <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                                {scanResult.opportunities_found > 0 ? (
                                    <>
                                        <span className="text-2xl">üéØ</span>
                                        <span className="text-green-400">
                                            {scanResult.opportunities_found} Oportunidade{scanResult.opportunities_found > 1 ? 's' : ''} Encontrada{scanResult.opportunities_found > 1 ? 's' : ''}
                                        </span>
                                    </>
                                ) : (
                                    <>
                                        <span className="text-2xl">‚úì</span>
                                        <span className="text-gray-400">
                                            Nenhuma oportunidade no momento
                                        </span>
                                        <span className="text-xs text-gray-500 ml-2">
                                            (comportamento esperado - arbitragem real √© rara)
                                        </span>
                                    </>
                                )}
                            </h2>

                            {scanResult.opportunities_found > 0 && (
                                <div className="grid gap-4">
                                    {scanResult.opportunities.map((opp, idx) => (
                                        <OpportunityCard 
                                            key={idx} 
                                            opportunity={opp} 
                                            rank={idx + 1}
                                        />
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Sem resultados */}
                    {!scanResult && !scanning && (
                        <div className="text-center py-20">
                            <div className="text-6xl mb-4">üîç</div>
                            <div className="text-xl text-gray-400">
                                Clique em "Escanear Agora" para buscar oportunidades
                            </div>
                            <div className="text-sm text-gray-500 mt-2">
                                O sistema ir√° analisar mercados das duas plataformas automaticamente
                            </div>
                        </div>
                    )}

                    {/* Footer */}
                    <footer className="mt-12 text-center text-gray-500 text-sm border-t border-gray-800 pt-6">
                        <p>‚ö†Ô∏è Sistema conservador - A maioria dos scans deve retornar 0 oportunidades</p>
                        <p className="mt-1">Arbitragem real √© rara. Se encontrar muitas constantemente, algo est√° errado.</p>
                        <p className="mt-2 text-xs">
                            Valida√ß√£o manual de equival√™ncia contratual recomendada antes de executar
                        </p>
                    </footer>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
